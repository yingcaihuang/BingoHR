name: Build & SSH Deploy to Azure VM

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (dev or pro)'
        required: true
        type: choice
        options:
          - dev
          - pro

permissions:
  contents: read

env:
  GO_VERSION: "1.20.x"
  APP_NAME: "bingohr-api"
  SERVICE_NAME: "bingohr"
  REMOTE_BASE: "/opt/bingohr"
  REMOTE_APP_DIR: "/opt/bingohr/api"

jobs:
  determine-environment:
    name: Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment from trigger
        id: env
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "environment=pro" >> $GITHUB_OUTPUT
            echo "Deployment target: pro (tag push)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "Deployment target: ${{ github.event.inputs.environment }} (manual dispatch)"
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "Deployment target: dev (main branch push)"
          fi

  build:
    name: Build Linux binary artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build linux/amd64 binary
        working-directory: api
        run: |
          set -euo pipefail
          go version
          mkdir -p dist
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o dist/${APP_NAME} .
          if [ ! -s "dist/${APP_NAME}" ]; then
            echo "::error title=Build failed::Binary dist/${APP_NAME} not created or empty";
            ls -lah dist || true
            exit 1
          fi

      - name: Package release (binary + config + fonts)
        working-directory: api
        run: |
          set -euo pipefail
          mkdir -p dist/package/runtime/fonts
          cp dist/${APP_NAME} dist/package/
          if [ ! -d conf ]; then
            echo "::error title=Missing config::Directory api/conf not found"; exit 1; fi
          cp -r conf dist/package/
          if [ -f runtime/fonts/msyhbd.ttc ]; then
            cp runtime/fonts/msyhbd.ttc dist/package/runtime/fonts/
          else
            echo "::warning title=Missing font::runtime/fonts/msyhbd.ttc not found; continuing without it"
          fi
          tar -C dist/package -czf dist/${APP_NAME}-linux-amd64.tar.gz .
          if [ ! -s "dist/${APP_NAME}-linux-amd64.tar.gz" ]; then
            echo "::error title=Package failed::Archive dist/${APP_NAME}-linux-amd64.tar.gz not created";
            ls -lah dist dist/package || true
            exit 1
          fi
          ls -lah dist

      - name: Verify artifact before upload
        working-directory: api
        run: |
          set -euo pipefail
          test -s "dist/${APP_NAME}-linux-amd64.tar.gz" || { echo "::error title=Artifact missing::api/dist/${APP_NAME}-linux-amd64.tar.gz not found"; exit 1; }
          echo "Artifact size:"; ls -lah "dist/${APP_NAME}-linux-amd64.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-amd64
          path: api/dist/${{ env.APP_NAME }}-linux-amd64.tar.gz

  deploy:
    name: Deploy to Azure VM via SSH
    needs: [build, determine-environment]
    environment: ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      start_time: ${{ steps.start_time.outputs.start_time }}
    steps:
      - name: Set Start Time
        id: start_time
        run: echo "start_time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Verify Environment and Secrets
        run: |
          set -euo pipefail
          echo "Current environment: ${{ needs.determine-environment.outputs.environment }}"
          echo "GitHub ref: ${{ github.ref }}"
          echo "Event name: ${{ github.event_name }}"
          if [ -z "${{ secrets.AZURE_VM_HOST }}" ]; then
            echo "::error title=Missing Secret::AZURE_VM_HOST is not configured in the ${{ needs.determine-environment.outputs.environment }} environment"
            exit 1
          fi
          if [ -z "${{ secrets.AZURE_VM_SSH_KEY }}" ]; then
            echo "::error title=Missing Secret::AZURE_VM_SSH_KEY is not configured in the ${{ needs.determine-environment.outputs.environment }} environment"
            exit 1
          fi
          echo "✓ Secrets verified for environment: ${{ needs.determine-environment.outputs.environment }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-amd64
          path: .

      - name: Verify downloaded artifact
        run: |
          set -euo pipefail
          if [ ! -s "${APP_NAME}-linux-amd64.tar.gz" ]; then
            echo "::error title=Downloaded artifact missing::${APP_NAME}-linux-amd64.tar.gz was not downloaded";
            ls -lah || true
            exit 1
          fi
          echo "Downloaded file:"; ls -lah "${APP_NAME}-linux-amd64.tar.gz"

      - name: Prepare SSH key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/azure_vm_id
          chmod 600 ~/.ssh/azure_vm_id

      - name: Upload package to VM
        env:
          HOST: ${{ secrets.AZURE_VM_HOST }}
          USER: ${{ secrets.AZURE_VM_USER }}
        run: |
          PORT=${{ secrets.AZURE_VM_SSH_PORT }}
          PORT=${PORT:-22}
          if [ ! -s "${APP_NAME}-linux-amd64.tar.gz" ]; then
            echo "::error title=Local file missing before upload::${APP_NAME}-linux-amd64.tar.gz not found"; exit 1; fi
          scp -i ~/.ssh/azure_vm_id -P "$PORT" -o StrictHostKeyChecking=no ${APP_NAME}-linux-amd64.tar.gz ${USER}@${HOST}:/tmp/${APP_NAME}.tar.gz

      - name: Install & restart service on VM
        shell: bash
        env:
          HOST: ${{ secrets.AZURE_VM_HOST }}
          USER: ${{ secrets.AZURE_VM_USER }}
          APP_NAME: ${{ env.APP_NAME }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}
          REMOTE_BASE: ${{ env.REMOTE_BASE }}
          REMOTE_APP_DIR: ${{ env.REMOTE_APP_DIR }}
        run: |
          PORT=${{ secrets.AZURE_VM_SSH_PORT }}
          PORT=${PORT:-22}
          ssh -i ~/.ssh/azure_vm_id -p "$PORT" -o StrictHostKeyChecking=no "$USER@$HOST" bash -c "'
          set -e

          sudo mkdir -p $REMOTE_APP_DIR
          sudo chown -R $USER:$USER $REMOTE_BASE

          if [ ! -s "/tmp/${APP_NAME}.tar.gz" ]; then
            echo "Remote package /tmp/${APP_NAME}.tar.gz missing" >&2; ls -lah /tmp || true; exit 1; fi

          # Unpack release
          tar -xzf /tmp/${APP_NAME}.tar.gz -C $REMOTE_APP_DIR
          rm -f /tmp/${APP_NAME}.tar.gz

          # Ensure runtime directories exist
          mkdir -p $REMOTE_APP_DIR/runtime/{logs,upload/images,export,qrcode,fonts}

          # Create/Update systemd unit
          sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOL
          [Unit]
          Description=${APP_NAME} service
          After=network.target

          [Service]
          Type=simple
          WorkingDirectory=${REMOTE_APP_DIR}
          ExecStart=${REMOTE_APP_DIR}/${APP_NAME}
          Restart=always
          RestartSec=5
          User=${USER}
          Environment=GIN_MODE=release

          [Install]
          WantedBy=multi-user.target
          EOL

          sudo systemctl daemon-reload
          sudo systemctl enable ${SERVICE_NAME} || true
          if ! sudo systemctl restart ${SERVICE_NAME}; then
            echo "Service restart failed" >&2
            sudo systemctl status ${SERVICE_NAME} --no-pager || true
            sudo journalctl -u ${SERVICE_NAME} --no-pager -n 200 || true
            exit 1
          fi

          # Status output
          sudo systemctl status ${SERVICE_NAME} --no-pager || true
          sudo journalctl -u ${SERVICE_NAME} --no-pager -n 50 || true
          '"


  notify:
    name: Notify Teams
    needs: [deploy, determine-environment]
    if: ${{ always() }}
    runs-on: ubuntu-latest
    steps:
      - name: Send Teams Notification
        uses: yingcaihuang/teams-notification-action@main
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          status: ${{ needs.deploy.result }}
          version: ${{ github.ref_name }}
          message: Deploy to Azure VM via SSH — ${{ github.event.head_commit.message }}
          start_time: ${{ needs.deploy.outputs.start_time }}
          title: BingoHR Deploy
